# OSPF
## About
- Open Shortest Path First (OSPF) is a link state routing protocol that support equal cost load balancing.
- Uses the shortest path first algorithm of Dutch computer scientist Edsger Dijkstra, thus OSPF is also known as Disjkstra's algorithm.

## Versions
- There are three versions:
    - OSPFv1 (1989): OLD, not in use anymore...
    - OSPFv2 (1998): Used for IPv4
    - OSPFv3 (2008): Used for IPv6 (can also be used for IPv4, but usually v2 is used)

## Link State Information
- Routers store information about the network in **LSAs** (link state advertisements), which are organized in a structure called the **LSDB** (link state database).
    - LSA's include: RID (router ID), IP (advertised network address), Cost (OSPF metric)
    - Each routers uses the SPF algorithm to calculate its best route to each LSA added to the LSDB.
    - Routers will **flood** LSAs until all routers in the OSPF area develop the same map of the network (LSDB).
    - Each LSA has an aging timer (30 minutes by default). The LSA will be flooed again after the timer expires.
- There are 11 types of LSA, but the three main ones to know for the CCNA are:
    - Type 1 (Router LSA)
        - Every OSPF router generates this type of LSA.
        - It identifies the router using its router ID.
        - It also lists networks attached to the router's OSPF-activated interfaces.
    - Type 2 (Network LSA)
        - Generated by the DR of each 'multi-access' network (ie. the **broadcast** network type).
        - Lists the routers which are attached to the multi-access network.
    - Type 5 (AS External LSA)
        - Generated by ASBR (Autonomous System Boundary Routers) to describe routes to destinations outside of the AS (OSPF domain).

## OSPF Areas
- OSPF uses areas to divide up the network. An area is a set of routers and links that share the same LSDB. OSPF areas must be contiguous, devices in an area
    - There is a **backbone area** (Area 0) by which all other area's have to connect to, e.g. Area 1, 2, 3, etc...
    - OSPF interfaces in the same subnet must be in the same area.
    - Routers connected to the backbone area are called **backbone routers**
    - Routers with all interfaces in the same area are called **internal routers**
    - Routers with interfaces in multiple areas are called **area border routers** (ABRs)
        - They maintain a seperate LSDB for each area they are connected to.
        - It is recommended that you connect an ABR to a maximum of 2 areas. Otherwise 3+ areas can overburden the router.
    - An **autonomous system boundary router** (ASBR) is an OSPF router that connects the OSPF network to an external network.
    - An **intra-area route** is a route to a destination inside the same OSPF area.
    - An **interarea route** is a route to a destination in a different OSPF area.
    - small networks can be single-area without any negative effects on performance.
    - In larger networks, a single-area design can have negative effects:
        - the SPF algorithm takes more time to calculate routes
        - the SPF algorithm requires exponentially more processing power on the routers
        - The larger LSDB takes up more memory on the routers
        - any small change in the network causes every router to flood LSAs and run the SPF algorithm again

## OSPF Cost
- OSPF's metric is called **cost**
    - it is automatically calculated based on the bandwidth (speed) of the interface.
    - It is calculated by dividing a **reference bandwidth** value by the interface's bandwidth. However, all values less than 1 will be converted to 1. By default FastEthernet, Gigabit Ethernet, 10Gig Ethernet, etc. are equal and all have a cost of 1 because the reference bandwidth is 100 mbps as shown below. But this is not ideal.
        **Reference:** 100 mbps / **Interface:** 10 mbps = cost of 10
        **Reference:** 100 mbps / **Interface:** 100 mbps = cost of 1     
        **Reference:** 100 mbps / **Interface:** 1000 mbps = cost of 1 (rounded up)
        **Reference:** 100 mbps / **Interface:** 10000 mbps = cost of 1 (rounded up)
    - Loopback interfaces have a cost of 1 by default.
    - The OSPF cost to a destination is the total cost of the 'outgoing/exit interfaces.' 
## Messages
- When OSPF is activated on a interface, the router states sending OSPF **hello** messages out of the interface at regular intervals (determined by the **hello timer**). 
    - These are used to introduce the router to potential OSPF neighbors. 
    - The default 'Hello' timer is 10 seconds on an Ethernet connection with the Broadcast or Point-to-point network type.
    - The 'Dead' timer is 40 seconds for both the Broadcast and Point-to-Point network types.
    - Hello messages are multicast to 224.0.0.5 (multicast address for all OSPF routers)
    - OSPF messages are encapsulated in an IP header, with a value of 89 in the protocol field.

## OSPF States
- (**DOWN STATE**) When OSPF is activated on an interface, it sends an OSPF hello message with it's Router ID (RID), and a Neighbor RID of 0.0.0.0 in the down state, since it doesn't know about any OSPF neighbors yet. 
- (**INIT STATE**) When a receiving router receives the OSPF Hello packet, but its own router ID is not in the Hello Packet, it adds the Router ID from the sending router to it's table and changes to the init state. 
- (**2-WAY STATE**) When a router sends a hello packet containing the RID of both routers. 
    - If both routers reach the 2-way state, it means that all the conditions have been met for them to become OSPF neighbors. They are now ready to share LSAs to build a common LSDB.
    - In some network types, a DR (Designated Router) and BDR (Backup Designated Router) will be elected at this point.
- (**EXSTART STATE**) To prepare exchanging information about their LSDB, both routers will have to select which one will start the exchange by sending DBD (Database Description) packets. They do this in the Exstart state, where the router with the higher RID will become the **master** and initiate the exchange. The router with the lower router RID will become the **slave**. 
- (**EXCHANGE STATE**) The routers exchange DBDs which contain a list of the LSAs in their LSDB. These DBDs do not include detailed information about the LSAs, just basic information. The routers compare the information in the DBD they received to the information in their own LSDB to determine which LSAs they must receive from their neighbor.
- (**LOADING STATE**) In the **Loading** state, routers send Link State Request (LSR) messages to request that their neighbors send them any LSAs they don't have. LSAs are sent in Link State Update (LSU) messages. The routers send LSAck messages to acknowledge that they received the LSAs.
- (**FULL STATE**) In the **Full** state, the routers have full OSPF adjacency and identical LSDBs. They continue to send and listen to Hello packets (every 10 secs by default) to maintain neighbor adjacency. Every time a Hello packet is received, the 'Dead' timer (40 seconds by default) is reset. If the Dead counter goes to 0, the neighbor is removed. The routers will continue to share LSAs as the network changes to make sure that each router has a complete and accurate map of the network (LSDB).
## OSPF Neighbor Requirements
1. Area number must match
2. Interfaces must be in the same subnet
3. OSPF process must not be shutdown
4. OSPF Router IDs must be unique
5. 'Hello' and 'Dead' timers must match 
6. Authentication settings must match
7. IP MTU settings must match, this sets the maximum size of the IP packet that will be sent out of an interface. The default is 1500 bytes. 
8. OSPF network type must match.

## OSPF Network Types
- The OSPF 'network type' refers to the type of connection between OSPF neighbors (Ethernet, FDDI, PPP, etc.)
- THere are three main OSPF network types: Broadcast, Point-to-Point, and Non-Broadcast.

### Broadcast
- Enabled by default on **Ethernet** and **FDDI** (Fiber Distributed Data Interface).
- Routers *dynamically discover* neighbors by sending / listening for OSPF Hello messages using multicast address 224.0.0.5.
- A **DR** (designated router) and **BDR** (backup designated router) must be elected on each subnet. However, if there are no OSPF neighbors, i.e. a router interface that connects to an end host, only the DR has to be selected.
- Routers which are not the DR and BDR become a **DROther**.
- DROthers will only move to the FULL state with the DR and BDR, the neighbor state with other DROthers will be 2-way.
- In the broadcast network type, routers will only form a full OSPF adjacency with the DR and BDR of the segment.
- Therefore, routers will only exchange LSAs with the DR and BDR. DROthers will not exchange LSAs with each other.
- All routers will still have the same LSDB, but this reduces the amount of LSAs flooding the network.
- Messages to the DR/BDR are mutlicast using address 224.0.0.6

#### DR/BDR Election
- The DR/BDR election order of priority is as follows. 
    1. The Highest **OSPF Interface Priority** (The default OSPF interface priority is 1 on all interfaces)
    2. The Highest OSPF Router ID
- First place becomes the DR for the subnet, second place becomes the BDR. 
- The election process is 'non-preemptive'. Once the DR/BDR are selected, they will keep their role until OSPF is reset, the interface fails/is shutdown, etc. 
- When the DR goes down, the BDR automatically becomes the new DR even if it doesn't have the highest priority. Then an election is held for the next BDR.

### Point-to-Point
- Enabled by default on serial interfaces using the **PPP** (Point-to-Point Protocol) and **HDLC** (High-Level Data Link Control) encapsulations which are used for 'point-to-point' connections. Therefore there is no need to elect a DR and BDR since a subnet with multiple routers is not formed.
- Routers *dynamically discover* neighbors by sending / listening for OSPF Hello messages using multicast address 224.0.0.5.
- A DR and BDR are **not** elected. The two routers will form a full adjacency with each other.

### Non-broadcast
- Enabled by default on **Frame Relay** and **X.25** interfaces.
- In this network type, you have to manually configure neighbors on the router, i.e. neighbors are not dynamically discovered.